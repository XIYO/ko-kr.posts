echo "🔍 Running pre-commit checks..."

# 1. Prettier로 포맷 체크
echo "📝 Checking code formatting..."
if ! pnpm lint; then
  echo "❌ Code formatting check failed. Run 'pnpm format' to fix."
  exit 1
fi

# 2. TypeScript/Svelte 타입 체크 (임시로 비활성화)
echo "🔧 Skipping type check for testing..."
# if ! pnpm check; then
#   echo "❌ Type check failed. Please fix the errors above."
#   exit 1
# fi

# 3. 블로그 포스트에 기본 frontmatter 추가
echo "📝 Adding basic frontmatter to blog posts..."

STAGED_MD=$(git diff --cached --name-only --diff-filter=ACM | grep '^posts/.*\.md$' || true)

if [ -n "$STAGED_MD" ]; then
  for file in $STAGED_MD; do
    if [ -f "$file" ] && ! grep -q "^---" "$file"; then
      echo "  📄 Processing: $file"
      if pnpm exec node scripts/add-basic-frontmatter.js "$file"; then
        git add "$file"
        echo "  ✅ Added frontmatter to $file"
      else
        echo "  ❌ Failed to process $file"
        exit 1
      fi
    elif [ -f "$file" ]; then
      echo "  ⏩ $file already has frontmatter"
    else
      echo "  ⏩ $file does not exist (deleted)"
    fi
  done
else
  echo "  ℹ️  No blog post files to process"
fi

echo "✅ All pre-commit checks passed!"